<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>–û–ø–ª–∞—Ç–∞ –û–ª–∏–º–ø–∏–∞–¥—ã</title>
        <link rel="stylesheet" href="http://localhost:8081/static/styles.css">
        <link rel="stylesheet" href="http://localhost:8081/static/payment.css">
    </head>
    
<body>
    <header class="header">
        <a href="/" class="logo">Dnevnik.kz</a>
        <nav>
            <ul>
                <li><a href="/list">–°–ø–∏—Å–æ–∫</a></li>
                <li><a href="/help">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</a></li>
                <li><a href="/dashboard">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a></li>
                <li><a href="/about">–û –Ω–∞—Å</a></li>
                <li><a href="/contact">–ê–¥–º–∏–Ω</a></li>
            </ul>
        </nav>
    </header>
    <div class="container">
        <h1>–û–ø–ª–∞—Ç–∞ —É—á–∞—Å—Ç–∏—è –≤ –û–ª–∏–º–ø–∏–∞–¥–µ</h1>
        <form id="paymentForm">
            <label>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã:</label>
            <input type="text" id="cardNumber" placeholder="0000 0000 0000 0000" required>
            
            <label>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (MM/YY):</label>
            <input type="text" id="expiry" placeholder="12/24" required>
            
            <label>CVV:</label>
            <input type="text" id="cvv" placeholder="123" required>

            <label>–°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã 1000—Ç–≥</label>
            
            <button type="submit">–û–ø–ª–∞—Ç–∏—Ç—å</button>
        </form>
        <p id="paymentStatus"></p>
    </div>

    <script>
        // ‚úÖ Check if user is logged in when the page loads
        window.addEventListener("load", () => {
            const loggedInUserId = localStorage.getItem("user_id");
            const token = localStorage.getItem("jwt");

            if (!loggedInUserId || !token) {
                alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã! –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –æ–ø–ª–∞—Ç–∏—Ç—å.");
                window.location.href = "/login"; // Redirect to login page
            }
        });
        async function createTransaction() {
            let loggedInUserId = localStorage.getItem("user_id");

            if (!loggedInUserId) {
                alert("–û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω!");
                window.location.href = "/login"; // Redirect to login
                return null;
            }

            let transactionData = {
                cart_id: "12345",
                amount: 1000.0,
                user_id: loggedInUserId // ‚úÖ Sending user_id correctly
            };

            console.log("üì§ Creating Transaction... Sending:", transactionData);

            try {
                const response = await fetch("http://localhost:8081/api/transaction", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(transactionData)
                });

                if (!response.ok) {
                    throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏");
                }

                const result = await response.json();
                console.log("‚úÖ Transaction Created:", result);
                return result.transaction_id; 
            } catch (error) {
                console.error("‚ùå Error creating transaction:", error);
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏!");
                return null;
            }
        }
    
        document.getElementById("paymentForm").addEventListener("submit", async function(event) {
            event.preventDefault();

            let loggedInUserId = localStorage.getItem("user_id");
            if (!loggedInUserId) {
                alert("–û—à–∏–±–∫–∞: –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã! –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –æ–ø–ª–∞—Ç–∏—Ç—å.");
                window.location.href = "/login"; // Redirect to login page
                return;
            }

            let transactionID = await createTransaction(); // Create transaction first
            if (!transactionID) {
                alert("–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é!");
                return;
            }

            let cardNumber = document.getElementById("cardNumber").value.replace(/\s/g, "");
            let expiry = document.getElementById("expiry").value.trim();
            let cvv = document.getElementById("cvv").value.trim();

            // Validate card input
            if (!/^\d{16}$/.test(cardNumber)) {
                alert("–û—à–∏–±–∫–∞: –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 16 —Ü–∏—Ñ—Ä!");
                return;
            }
            if (!/^\d{2}\/\d{2}$/.test(expiry)) {
                alert("–û—à–∏–±–∫–∞: –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM/YY!");
                return;
            }
            if (!/^\d{3}$/.test(cvv)) {
                alert("–û—à–∏–±–∫–∞: CVV –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 3 —Ü–∏—Ñ—Ä—ã!");
                return;
            }

            let requestData = {
                transaction_id: transactionID,
                card_number: cardNumber,
                expiry: expiry,
                cvv: cvv
            };

            console.log("üì§ Sending Payment Request:", requestData);

            try {
                const response = await fetch("http://localhost:8081/api/payment", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞");
                }

                const result = await response.json();
                console.log("‚úÖ Payment Response:", result);
                document.getElementById("paymentStatus").innerText = `–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã: ${result.status}`;
            } catch (error) {
                console.error("‚ùå Payment Error:", error);
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞!");
            }
        });
    </script>
</body>
</html>
