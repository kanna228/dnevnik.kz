<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ - –ß–∞—Ç—ã</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/help.css">
</head>
<body>
    <header class="header">
        <a href="/" class="logo">Dnevnik.kz</a>
        <nav>
            <ul>
                <li><a href="/list">–°–ø–∏—Å–æ–∫</a></li>
                <li><a href="/help">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</a></li>
                <li><a href="/dashboard">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a></li>
                <li><a href="/about">–û –Ω–∞—Å</a></li>
                <li><a href="/contact">–ê–¥–º–∏–Ω</a></li>
            </ul>
        </nav>
    </header>
    <!-- –°–∫—Ä—ã—Ç—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <input type="hidden" id="user-role" value="{{.UserRole}}">
    
    <main class="chat-container">
        <h2>–í–∞—à–∏ —á–∞—Ç—ã</h2>
        <button id="create-chat-btn">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç</button>
        <div id="chat-list"></div>
    </main>
    
    <footer class="footer">
        <p>&copy; 2025 Dnevnik.kz - –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
    </footer>

    <script>
        const API_BASE = window.location.hostname === "localhost" 
            ? "http://localhost:8080/api" // Local API
            : "https://dnevnik-kz.onrender.com/api"; // Production API
    
        async function fetchUserInfo() {
            const token = localStorage.getItem("jwt");
    
            if (!token) {
                // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
                window.location.href = "/login";
                return;
            }
    
            const response = await fetch(`${API_BASE}/user`, {
                method: "GET",
                headers: {
                    "Authorization": token, // –ü–µ—Ä–µ–¥–∞—ë–º —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
                },
            });
    
            if (response.ok) {
                const userInfo = await response.json();
                
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—á–∏—Ç–µ–ª—å ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–°–æ–∑–¥–∞—Ç—å —á–∞—Ç"
                if (userInfo.role === "teacher") {
                    document.getElementById("create-chat-btn").style.display = "none";
                } else {
                    // –ï—Å–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É
                    document.getElementById("create-chat-btn").addEventListener("click", createChat);
                }
            } else {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ");
                localStorage.removeItem("jwt"); // –£–¥–∞–ª—è–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω
                window.location.href = "/login"; // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≤—Ö–æ–¥
            }
        }
    
        async function createChat() {
            const chatTitle = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞:");
            if (!chatTitle) return;
        
            const token = localStorage.getItem("jwt");
            if (!token) {
                alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã!");
                return;
            }
        
            const requestBody = JSON.stringify({ title: chatTitle });
        
            console.log("üîπ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞:", requestBody);
        
            try {
                const response = await fetch(`${API_BASE}/create_chat`, {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: requestBody
                });
        
                const data = await response.text(); // –ß–∏—Ç–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏ JSON.parse()
        
                console.log("üîπ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);
        
                if (response.status === 409) {
                    alert("–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç. –ó–∞–≤–µ—Ä—à–∏—Ç–µ –µ–≥–æ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ.");
                    return;
                }
        
                if (response.ok) {
                    alert("–ß–∞—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!");
                    location.reload();
                } else {
                    alert(`–û—à–∏–±–∫–∞: ${data}`);
                }
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞:", error);
                alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞");
            }
        }
    
        // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        fetchUserInfo();
        async function loadChats() {
            const token = localStorage.getItem("jwt");
            if (!token) {
                console.log("‚ùå –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç");
                return;
            }
    
            try {
                const response = await fetch(`${API_BASE}/get_chats`, {
                    method: "GET",
                    headers: { "Authorization": `Bearer ${token}` }
                });
    
                if (!response.ok) {
                    throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–æ–≤");
                }
    
                const chats = await response.json();
                console.log("üîπ –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —á–∞—Ç—ã:", chats);
    
                const chatList = document.getElementById("chat-list");
                chatList.innerHTML = ""; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
    
                if (chats.length === 0) {
                    chatList.innerHTML = "<p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</p>";
                    return;
                }
    
                chats.forEach(chat => {
                    const chatCard = document.createElement("div");
                    chatCard.classList.add("chat-card");
                    chatCard.dataset.chatId = chat.id; // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º ID —á–∞—Ç–∞ –¥–ª—è –∫–ª–∏–∫–æ–≤ –≤ –±—É–¥—É—â–µ–º
                    chatCard.innerHTML = `
                        <h3>${chat.title}</h3>
                        <p>–°—Ç–∞—Ç—É—Å: ${chat.status === "active" ? "üü¢ –ê–∫—Ç–∏–≤–Ω—ã–π" : "üî¥ –ó–∞–∫—Ä—ã—Ç"}</p>
                    `;
                    chatList.appendChild(chatCard);
                });
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–æ–≤:", error);
            }
        }
    
        document.addEventListener("DOMContentLoaded", function() {
            fetchUserInfo(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            loadChats(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã
        });
    </script>
</body>
</html>




