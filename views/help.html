<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ - –ß–∞—Ç—ã</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/help.css">
</head>
<body>
    <header class="header">
        <a href="/" class="logo">Dnevnik.kz</a>
        <nav>
            <ul>
                <li><a href="/list">–°–ø–∏—Å–æ–∫</a></li>
                <li><a href="/help">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</a></li>
                <li><a href="/dashboard">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a></li>
                <li><a href="/about">–û –Ω–∞—Å</a></li>
                <li><a href="/contact">–ê–¥–º–∏–Ω</a></li>
            </ul>
        </nav>
    </header>
    <!-- –°–∫—Ä—ã—Ç—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <input type="hidden" id="user-role" value="{{.UserRole}}">
    
    <main class="chat-container">
        <h2>–í–∞—à–∏ —á–∞—Ç—ã</h2>
        <button id="create-chat-btn">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç</button>
        <div id="chat-list"></div>
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —á–∞—Ç–∞ -->
        <div id="chat-modal" class="chat-modal" style="display: none;">
            <div class="chat-modal-content">
                <span id="close-chat-btn" class="close-btn">&times;</span>
                <h3 id="chat-title">–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞</h3>
                <div id="chat-messages" class="chat-messages"></div>
                <input type="text" id="chat-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
                <button id="send-chat-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </main>
    
    <footer class="footer">
        <p>&copy; 2025 Dnevnik.kz - –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
    </footer>

    <script>
        const API_BASE = window.location.hostname === "localhost" 
            ? "http://localhost:8080/api" // Local API
            : "https://dnevnik-kz.onrender.com/api"; // Production API
    
        async function fetchUserInfo() {
            const token = localStorage.getItem("jwt");
    
            if (!token) {
                // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
                window.location.href = "/login";
                return;
            }
    
            const response = await fetch(`${API_BASE}/user`, {
                method: "GET",
                headers: {
                    "Authorization": token, // –ü–µ—Ä–µ–¥–∞—ë–º —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
                },
            });
    
            if (response.ok) {
                const userInfo = await response.json();
                
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—á–∏—Ç–µ–ª—å ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–°–æ–∑–¥–∞—Ç—å —á–∞—Ç"
                if (userInfo.role === "teacher") {
                    document.getElementById("create-chat-btn").style.display = "none";
                } else {
                    // –ï—Å–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É
                    document.getElementById("create-chat-btn").addEventListener("click", createChat);
                }
            } else {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ");
                localStorage.removeItem("jwt"); // –£–¥–∞–ª—è–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω
                window.location.href = "/login"; // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≤—Ö–æ–¥
            }
        }
    
        async function createChat() {
            const chatTitle = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞:");
            if (!chatTitle) return;
        
            const token = localStorage.getItem("jwt");
            if (!token) {
                alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã!");
                return;
            }
        
            const requestBody = JSON.stringify({ title: chatTitle });
        
            console.log("üîπ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞:", requestBody);
        
            try {
                const response = await fetch(`${API_BASE}/create_chat`, {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: requestBody
                });
        
                const data = await response.text(); // –ß–∏—Ç–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏ JSON.parse()
        
                console.log("üîπ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);
        
                if (response.status === 409) {
                    alert("–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç. –ó–∞–≤–µ—Ä—à–∏—Ç–µ –µ–≥–æ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ.");
                    return;
                }
        
                if (response.ok) {
                    alert("–ß–∞—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!");
                    location.reload();
                } else {
                    alert(`–û—à–∏–±–∫–∞: ${data}`);
                }
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞:", error);
                alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞");
            }
        }
    
        // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        fetchUserInfo();
        let socket;
        let currentChatId = null;
        
        async function openChat(chatId, chatTitle) {
            document.getElementById("chat-modal").style.display = "block";
            document.getElementById("chat-title").innerText = chatTitle;
        
            currentChatId = chatId;
        
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º WebSocket –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
            socket = new WebSocket(`ws://localhost:8080/ws?chat_id=${chatId}`);
        
            socket.onopen = () => {
                console.log("‚úÖ WebSocket connected to chat:", chatId);
            };
        
            socket.onmessage = (event) => {
                const message = JSON.parse(event.data);
                const chatMessages = document.getElementById("chat-messages");
        
                const messageElement = document.createElement("div");
                messageElement.classList.add("chat-message");
        
                if (message.sender_id === localStorage.getItem("user_id")) {
                    messageElement.classList.add("sent"); // –≠—Ç–æ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                } else {
                    messageElement.classList.add("received"); // –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                }
        
                messageElement.textContent = message.content;
                chatMessages.appendChild(messageElement);
        
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –≤–Ω–∏–∑, —á—Ç–æ–±—ã –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—ã–ª–æ –≤–∏–¥–Ω–æ
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };
        
            socket.onclose = () => {
                console.log("‚ùå WebSocket disconnected");
            };
        
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            loadChatHistory(chatId);
        }
        
        async function loadChatHistory(chatId) {
            const token = localStorage.getItem("jwt");
            if (!token) {
                console.log("‚ùå –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç");
                return;
            }
        
            try {
                const response = await fetch(`${API_BASE}/get_chat_history?chat_id=${chatId}`, {
                    method: "GET",
                    headers: { "Authorization": `Bearer ${token}` }
                });
        
                if (!response.ok) {
                    throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞");
                }
        
                const messages = await response.json();
                const chatMessages = document.getElementById("chat-messages");
                chatMessages.innerHTML = ""; // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        
                if (messages.length === 0) {
                    chatMessages.innerHTML = "<p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —ç—Ç–æ–º —á–∞—Ç–µ</p>";
                    return;
                }
        
                messages.forEach((message) => {
                    const messageElement = document.createElement("div");
                    messageElement.classList.add("chat-message");
                    messageElement.textContent = message.content; // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                    chatMessages.appendChild(messageElement);
                });
        
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞:", error);
            }
        }
        
        document.getElementById("close-chat-btn").addEventListener("click", function() {
            document.getElementById("chat-modal").style.display = "none";
            if (socket) {
                socket.close();
            }
        });
        
        document.getElementById("send-chat-btn").addEventListener("click", function() {
            const chatInput = document.getElementById("chat-input");
            const messageContent = chatInput.value.trim();
        
            if (messageContent && socket) {
                const userInfo = getUserInfoFromLocalStorage();
                const message = {
                    chatId: currentChatId,
                    content: messageContent,
                    sender_id: userInfo.userId,
                    username: userInfo.username
                };
        
                socket.send(JSON.stringify(message));
                chatInput.value = "";
            }
        });
        

        function getUserInfoFromLocalStorage() {
            const token = localStorage.getItem("jwt");
            if (!token) {
                console.log("‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω");
                return null;
            }

            try {
                const claims = JSON.parse(atob(token.split('.')[1]));
                return {
                    userId: claims.id,
                    username: claims.username
                };
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞:", e);
                return null;
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            loadChats();
        });

        async function loadChats() {
            const token = localStorage.getItem("jwt");
            if (!token) {
                console.log("‚ùå –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç");
                return;
            }
        
            try {
                const response = await fetch(`${API_BASE}/get_chats`, {
                    method: "GET",
                    headers: { "Authorization": `Bearer ${token}` }
                });
        
                if (!response.ok) {
                    throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–æ–≤");
                }
        
                const chats = await response.json();
                const chatList = document.getElementById("chat-list");
                chatList.innerHTML = "";
        
                if (chats.length === 0) {
                    chatList.innerHTML = "<p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</p>";
                    return;
                }
        
                chats.forEach(chat => {
                    const chatCard = document.createElement("div");
                    chatCard.classList.add("chat-card");
                    chatCard.dataset.chatId = chat.id;
                    chatCard.innerHTML = `
                        <h3>${chat.title}</h3>
                        <p>–°—Ç–∞—Ç—É—Å: ${chat.status === "active" ? "üü¢ –ê–∫—Ç–∏–≤–Ω—ã–π" : "üî¥ –ó–∞–∫—Ä—ã—Ç"}</p>
                    `;
                    
                    // –ü—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ)
                    chatCard.addEventListener("click", function() {
                        openChat(chat.id, chat.title);
                    });
                    
                    // –ï—Å–ª–∏ —á–∞—Ç –∞–∫—Ç–∏–≤–Ω—ã–π, –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –µ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
                    if (chat.status === "active") {
                        const closeBtn = document.createElement("button");
                        closeBtn.textContent = "–ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç";
                        closeBtn.addEventListener("click", function(e) {
                            e.stopPropagation(); // —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª openChat
                            closeChat(chat.id);
                        });
                        chatCard.appendChild(closeBtn);
                    }
                    
                    chatList.appendChild(chatCard);
                });
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–æ–≤:", error);
            }
        }
        
        async function closeChat(chatId) {
            const token = localStorage.getItem("jwt");
            if (!token) {
                console.error("‚ùå –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç");
                return;
            }
        
            try {
                const response = await fetch(`${API_BASE}/close_chat?chat_id=${chatId}`, {
                    method: "POST", // –º–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PATCH
                    headers: {
                        "Authorization": `Bearer ${token}`
                    }
                });
        
                if (!response.ok) {
                    throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞");
                }
        
                const data = await response.json();
                console.log("‚úÖ", data.message);
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤, —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—ã–π —á–∞—Ç –∏—Å—á–µ–∑ –∏–∑ –≤–∏–¥–∏–º–æ–≥–æ —Å–ø–∏—Å–∫–∞
                loadChats();
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞:", error);
            }
        }
        

        
    </script>
</body>
</html>




